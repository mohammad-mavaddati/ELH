<!DOCTYPE html><html lang="fa">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>چت خصوصی محمد و الهام</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 flex items-center justify-center h-screen p-4">
  <div id="container" class="w-full max-w-md bg-white rounded-2xl shadow-lg flex flex-col overflow-hidden">
    <div class="bg-blue-600 text-white text-center py-4 text-xl font-semibold">
      چت خصوصی محمد و الهام
    </div>
    <div id="auth" class="p-6 space-y-4">
      <div>
        <label class="block text-gray-700">ماه تولد:</label>
        <select id="birth-month" class="mt-1 block w-full border border-gray-300 rounded-lg p-2">
          <option value="">-- انتخاب ماه --</option>
        </select>
      </div>
      <div>
        <label class="block text-gray-700">روز تولد:</label>
        <select id="birth-day" disabled class="mt-1 block w-full border border-gray-300 rounded-lg p-2">
          <option value="">-- انتخاب روز --</option>
        </select>
      </div>
      <div id="password-container" class="hidden">
        <label class="block text-gray-700">رمز عبور:</label>
        <input id="password" type="password" placeholder="رمز خود را وارد کنید" class="mt-1 block w-full border border-gray-300 rounded-lg p-2" />
      </div>
      <button id="login-btn" disabled class="w-full bg-blue-600 text-white py-2 rounded-lg font-medium disabled:bg-blue-300">
        ورود
      </button>
    </div>
    <div id="chat-ui" class="hidden flex-1 flex flex-col">
      <div id="last-seen" class="text-center text-sm text-gray-500 m-2"></div>
      <div id="chat" class="flex-1 overflow-y-auto p-4 space-y-2 scrollbar-thin scrollbar-thumb-gray-400"></div>
      <div class="flex items-center p-4 border-t border-gray-200">
        <input id="msg" type="text" placeholder="پیام بنویسید..." class="flex-1 border border-gray-300 rounded-lg p-2 mr-2 focus:outline-none" />
        <button id="send-btn" class="bg-green-500 text-white px-4 py-2 rounded-lg font-medium">ارسال</button>
      </div>
      <button id="clear-btn" class="m-4 bg-red-500 text-white py-2 rounded-lg font-medium hidden">پاک کردن تاریخچه</button>
    </div>
  </div>  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
    import {
      getDatabase, ref, push, onChildAdded, onChildRemoved,
      query, limitToLast, remove, set, get
    } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA5_iPT-1YjlJgKCsl6wNAIb-jsCTyoSKI",
      authDomain: "elhh-e2eee.firebaseapp.com",
      databaseURL: "https://elhh-e2eee-default-rtdb.firebaseio.com",
      projectId: "elhh-e2eee",
      storageBucket: "elhh-e2eee.appspot.com",
      messagingSenderId: "1035622425636",
      appId: "1:1035622425636:web:09dd18e687490f9e22a4b1",
      measurementId: "G-2X7EH2QCJE"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    let user = null;

    const monthSel = document.getElementById('birth-month');
    const daySel = document.getElementById('birth-day');
    const passwordDiv = document.getElementById('password-container');
    const passInput = document.getElementById('password');
    const loginBtn = document.getElementById('login-btn');
    const authDiv = document.getElementById('auth');
    const chatUi = document.getElementById('chat-ui');
    const chatDiv = document.getElementById('chat');
    const sendBtn = document.getElementById('send-btn');
    const msgInput = document.getElementById('msg');
    const clearBtn = document.getElementById('clear-btn');
    const lastSeenDiv = document.getElementById('last-seen');

    function showError(msg) {
      alert(`\u26A0\uFE0F خطا: ${msg}`);
    }

    window.addEventListener('offline', () => showError('اتصال اینترنت قطع شد'));
    window.addEventListener('online', () => alert('اتصال اینترنت برقرار شد'));

    [{ v: 10, t: 'دی' }, { v: 1, t: 'فروردین' }, { v: 2, t: 'اردیبهشت' }].forEach(m => {
      const o = document.createElement('option');
      o.value = m.v;
      o.textContent = m.t;
      monthSel.append(o);
    });

    monthSel.addEventListener('change', () => {
      daySel.innerHTML = '<option value="">-- انتخاب روز --</option>';
      if (monthSel.value) {
        daySel.disabled = false;
        for (let i = 1; i <= 31; i++) {
          const o = document.createElement('option');
          o.value = i;
          o.textContent = i;
          daySel.append(o);
        }
      } else {
        daySel.disabled = true;
      }
      togglePasswordField();
      toggleLoginButton();
    });

    daySel.addEventListener('change', () => {
      togglePasswordField();
      toggleLoginButton();
    });
    passInput.addEventListener('input', toggleLoginButton);

    function togglePasswordField() {
      const isMohamad = (+monthSel.value === 10 && +daySel.value === 7);
      passwordDiv.classList.toggle('hidden', !isMohamad);
    }
    function toggleLoginButton() {
      const m = +monthSel.value, d = +daySel.value;
      const needPass = (m === 10 && d === 7);
      loginBtn.disabled = !(m && d && (!needPass || passInput.value));
    }

    loginBtn.addEventListener('click', async () => {
      const m = +monthSel.value, d = +daySel.value;
      if (m === 10 && d === 7) {
        if (passInput.value !== 'mohamad200') return showError('رمز اشتباه است');
        user = 'محمد';
      } else if (m === 10 && d === 13) {
        user = 'الهام';
      } else {
        return showError('دسترسی فقط برای محمد و الهام مجاز است');
      }

      try {
        await set(ref(db, 'lastSeen/' + user), Date.now());
      } catch (err) {
        return showError('خطا در ثبت وضعیت آنلاین');
      }

      authDiv.classList.add('hidden');
      chatUi.classList.remove('hidden');
      if (user === 'محمد') clearBtn.classList.remove('hidden');

      if (user === 'محمد') {
        try {
          const snap = await get(ref(db, 'lastSeen/الهام'));
          if (snap.exists()) {
            const last = new Date(+snap.val());
            const mins = Math.floor((Date.now() - last.getTime()) / 60000);
            lastSeenDiv.textContent = 'آخرین بازدید الهام: ' + (mins < 1 ? 'همین الان' : mins + ' دقیقه پیش');
          }
        } catch {
          lastSeenDiv.textContent = 'وضعیت آنلاین در دسترس نیست';
        }
      }

      try {
        const cache = JSON.parse(localStorage.getItem('chat-cache') || '{}');
        Object.entries(cache).forEach(([key, msg]) => appendMessage(key, msg));
      } catch {}

      const msgsRef = ref(db, 'messages');
      const recentQ = query(msgsRef, limitToLast(50));
      onChildAdded(recentQ, snap => {
        const key = snap.key, msg = snap.val();
        appendMessage(key, msg);
        try {
          const c = JSON.parse(localStorage.getItem('chat-cache') || '{}');
          c[key] = msg;
          localStorage.setItem('chat-cache', JSON.stringify(c));
        } catch {}
      });
      onChildRemoved(msgsRef, snap => {
        const key = snap.key;
        document.getElementById(key)?.remove();
        try {
          const c = JSON.parse(localStorage.getItem('chat-cache') || '{}');
          delete c[key];
          localStorage.setItem('chat-cache', JSON.stringify(c));
        } catch {}
      });
    });

    function appendMessage(key, msg) {
      if (document.getElementById(key)) return;
      const d = document.createElement('div');
      d.id = key;
      d.className = [
        'p-3', 'rounded-lg', 'max-w-[75%]', 'break-words',
        msg.from === user ? 'bg-green-100 self-end text-right' : 'bg-blue-100 self-start text-left'
      ].join(' ');
      d.textContent = `${msg.from}: ${msg.text}`;

      if (user === 'محمد') {
        const btn = document.createElement('button');
        btn.textContent = '×';
        btn.className = 'absolute top-1 right-1 text-gray-500 hover:text-red-500';
        btn.onclick = async () => {
          try {
            await remove(ref(db, 'messages/' + key));
          } catch {
            showError('حذف پیام با خطا مواجه شد');
          }
        };
        d.classList.add('relative');
        d.append(btn);
      }
      chatDiv.append(d);
      chatDiv.scrollTop = chatDiv.scrollHeight;
    }

    sendBtn.addEventListener('click', async () => {
      if (!msgInput.value.trim()) return;
      try {
        await push(ref(db, 'messages'), { from: user, text: msgInput.value });
        msgInput.value = '';
      } catch {
        showError('ارسال پیام با خطا مواجه شد');
      }
    });

    msgInput.addEventListener('keypress', e => {
      if (e.key === 'Enter') sendBtn.click();
    });

    clearBtn.addEventListener('click', async () => {
      if (!confirm('پاک شدن کامل چت؟')) return;
      try {
        await remove(ref(db, 'messages'));
        localStorage.removeItem('chat-cache');
        chatDiv.innerHTML = '';
      } catch {
        showError('خطا در پاک‌سازی چت');
      }
    });
  </script></body>
</html>
