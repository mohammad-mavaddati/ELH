<!DOCTYPE html>
<html lang="fa"><head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>چت خصوصی محمد و الهام</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
<style>*, ::before, ::after{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgb(59 130 246 / 0.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }::backdrop{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgb(59 130 246 / 0.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }/* ! tailwindcss v3.4.16 | MIT License | https://tailwindcss.com */*,::after,::before{box-sizing:border-box;border-width:0;border-style:solid;border-color:#e5e7eb}::after,::before{--tw-content:''}:host,html{line-height:1.5;-webkit-text-size-adjust:100%;-moz-tab-size:4;tab-size:4;font-family:ui-sans-serif, system-ui, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";font-feature-settings:normal;font-variation-settings:normal;-webkit-tap-highlight-color:transparent}body{margin:0;line-height:inherit}hr{height:0;color:inherit;border-top-width:1px}abbr:where([title]){-webkit-text-decoration:underline dotted;text-decoration:underline dotted}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}b,strong{font-weight:bolder}code,kbd,pre,samp{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;font-feature-settings:normal;font-variation-settings:normal;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}table{text-indent:0;border-color:inherit;border-collapse:collapse}button,input,optgroup,select,textarea{font-family:inherit;font-feature-settings:inherit;font-variation-settings:inherit;font-size:100%;font-weight:inherit;line-height:inherit;letter-spacing:inherit;color:inherit;margin:0;padding:0}button,select{text-transform:none}button,input:where([type=button]),input:where([type=reset]),input:where([type=submit]){-webkit-appearance:button;background-color:transparent;background-image:none}:-moz-focusring{outline:auto}:-moz-ui-invalid{box-shadow:none}progress{vertical-align:baseline}::-webkit-inner-spin-button,::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}summary{display:list-item}blockquote,dd,dl,figure,h1,h2,h3,h4,h5,h6,hr,p,pre{margin:0}fieldset{margin:0;padding:0}legend{padding:0}menu,ol,ul{list-style:none;margin:0;padding:0}dialog{padding:0}textarea{resize:vertical}input::placeholder,textarea::placeholder{opacity:1;color:#9ca3af}[role=button],button{cursor:pointer}:disabled{cursor:default}audio,canvas,embed,iframe,img,object,svg,video{display:block;vertical-align:middle}img,video{max-width:100%;height:auto}[hidden]:where(:not([hidden=until-found])){display:none}.m-2{margin:0.5rem}.m-4{margin:1rem}.mr-2{margin-right:0.5rem}.mt-1{margin-top:0.25rem}.mb-10{margin-bottom:2.5rem}.block{display:block}.flex{display:flex}.hidden{display:none}.h-screen{height:100vh}.w-full{width:100%}.max-w-md{max-width:28rem}.max-w-\[75\%\]{max-width:75%}.flex-1{flex:1 1 0%}.flex-col{flex-direction:column}.items-center{align-items:center}.justify-center{justify-content:center}.justify-between{justify-content:space-between}.space-y-2 > :not([hidden]) ~ :not([hidden]){--tw-space-y-reverse:0;margin-top:calc(0.5rem * calc(1 - var(--tw-space-y-reverse)));margin-bottom:calc(0.5rem * var(--tw-space-y-reverse))}.space-y-4 > :not([hidden]) ~ :not([hidden]){--tw-space-y-reverse:0;margin-top:calc(1rem * calc(1 - var(--tw-space-y-reverse)));margin-bottom:calc(1rem * var(--tw-space-y-reverse))}.self-start{align-self:flex-start}.self-end{align-self:flex-end}.overflow-hidden{overflow:hidden}.overflow-y-auto{overflow-y:auto}.break-words{overflow-wrap:break-word}.rounded{border-radius:0.25rem}.rounded-2xl{border-radius:1rem}.rounded-lg{border-radius:0.5rem}.border{border-width:1px}.border-b{border-bottom-width:1px}.border-t{border-top-width:1px}.border-gray-200{--tw-border-opacity:1;border-color:rgb(229 231 235 / var(--tw-border-opacity, 1))}.border-gray-300{--tw-border-opacity:1;border-color:rgb(209 213 219 / var(--tw-border-opacity, 1))}.bg-blue-500{--tw-bg-opacity:1;background-color:rgb(59 130 246 / var(--tw-bg-opacity, 1))}.bg-blue-600{--tw-bg-opacity:1;background-color:rgb(37 99 235 / var(--tw-bg-opacity, 1))}.bg-gray-100{--tw-bg-opacity:1;background-color:rgb(243 244 246 / var(--tw-bg-opacity, 1))}.bg-gray-50{--tw-bg-opacity:1;background-color:rgb(249 250 251 / var(--tw-bg-opacity, 1))}.bg-green-500{--tw-bg-opacity:1;background-color:rgb(34 197 94 / var(--tw-bg-opacity, 1))}.bg-red-500{--tw-bg-opacity:1;background-color:rgb(239 68 68 / var(--tw-bg-opacity, 1))}.bg-white{--tw-bg-opacity:1;background-color:rgb(255 255 255 / var(--tw-bg-opacity, 1))}.bg-blue-100{--tw-bg-opacity:1;background-color:rgb(219 234 254 / var(--tw-bg-opacity, 1))}.bg-green-100{--tw-bg-opacity:1;background-color:rgb(220 252 231 / var(--tw-bg-opacity, 1))}.p-2{padding:0.5rem}.p-4{padding:1rem}.p-6{padding:1.5rem}.p-3{padding:0.75rem}.px-3{padding-left:0.75rem;padding-right:0.75rem}.px-4{padding-left:1rem;padding-right:1rem}.py-1{padding-top:0.25rem;padding-bottom:0.25rem}.py-2{padding-top:0.5rem;padding-bottom:0.5rem}.py-4{padding-top:1rem;padding-bottom:1rem}.text-left{text-align:left}.text-center{text-align:center}.text-right{text-align:right}.text-sm{font-size:0.875rem;line-height:1.25rem}.text-xl{font-size:1.25rem;line-height:1.75rem}.text-xs{font-size:0.75rem;line-height:1rem}.font-medium{font-weight:500}.font-semibold{font-weight:600}.font-bold{font-weight:700}.text-gray-500{--tw-text-opacity:1;color:rgb(107 114 128 / var(--tw-text-opacity, 1))}.text-gray-700{--tw-text-opacity:1;color:rgb(55 65 81 / var(--tw-text-opacity, 1))}.text-white{--tw-text-opacity:1;color:rgb(255 255 255 / var(--tw-text-opacity, 1))}.text-orange-500{--tw-text-opacity:1;color:rgb(249 115 22 / var(--tw-text-opacity, 1))}.text-red-500{--tw-text-opacity:1;color:rgb(239 68 68 / var(--tw-text-opacity, 1))}.text-green-600{--tw-text-opacity:1;color:rgb(22 163 74 / var(--tw-text-opacity, 1))}.shadow-lg{--tw-shadow:0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);--tw-shadow-colored:0 10px 15px -3px var(--tw-shadow-color), 0 4px 6px -4px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.focus\:outline-none:focus{outline:2px solid transparent;outline-offset:2px}.disabled\:bg-blue-300:disabled{--tw-bg-opacity:1;background-color:rgb(147 197 253 / var(--tw-bg-opacity, 1))}</style></head>
<body class="bg-gray-100 flex flex-col items-center justify-center h-screen p-4">
 <div id="connection-status" class="flex bg-blue-100 max-w-md w-full items-center mb-10 justify-between px-4 py-2 bg-gray-50 border-b rounded-2xl border-gray-200">
      <span id="status-text" class="text-sm text-green-600 font-bold">checking connection</span>
      <button id="refresh-btn" class="bg-blue-500 text-white px-3 py-1 rounded text-xs">refresh page</button>
    </div>
    <div id="container" class="w-full max-w-md bg-white rounded-2xl shadow-lg flex flex-col overflow-hidden">
    <!-- وضعیت اتصال و دکمه رفرش -->
    
    <div class="bg-blue-600 text-white text-center py-4 text-xl font-semibold">
      چت خصوصی محمد و الهام
    </div>
    <div id="auth" class="p-6 space-y-4 hidden">
      <div>
        <label class="block text-gray-700">ماه تولد:</label>
        <select id="birth-month" class="mt-1 block w-full border border-gray-300 rounded-lg p-2">
          <option value="">-- انتخاب ماه --</option>
        <option value="10">دی</option><option value="1">فروردین</option><option value="2">اردیبهشت</option></select>
      </div>
      <div>
        <label class="block text-gray-700">روز تولد:</label>
        <select id="birth-day" class="mt-1 block w-full border border-gray-300 rounded-lg p-2"><option value="">-- انتخاب روز --</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="9">9</option><option value="10">10</option><option value="11">11</option><option value="12">12</option><option value="13">13</option><option value="14">14</option><option value="15">15</option><option value="16">16</option><option value="17">17</option><option value="18">18</option><option value="19">19</option><option value="20">20</option><option value="21">21</option><option value="22">22</option><option value="23">23</option><option value="24">24</option><option value="25">25</option><option value="26">26</option><option value="27">27</option><option value="28">28</option><option value="29">29</option><option value="30">30</option><option value="31">31</option></select>
      </div>
      <div id="password-container" class="hidden">
        <label class="block text-gray-700">رمز عبور:</label>
        <input id="password" type="password" placeholder="رمز خود را وارد کنید" class="mt-1 block w-full border border-gray-300 rounded-lg p-2">
      </div>
      <button id="login-btn" class="w-full bg-blue-600 text-white py-2 rounded-lg font-medium disabled:bg-blue-300">
        ورود
      </button>
    </div>
    <div id="chat-ui" class="flex-1 flex flex-col">
      <div id="last-seen" class="text-center text-sm text-gray-500 m-2"></div>
      <div id="chat" class="flex-1 overflow-y-auto p-4 space-y-2 scrollbar-thin scrollbar-thumb-gray-400"><div id="-ORQ4MkGsf5DNDjTDefS" class="p-3 rounded-lg max-w-[75%] break-words bg-blue-100 self-start text-left">محمد: Salam</div><div id="-ORQ4OBiaiapEKsmnwYW" class="p-3 rounded-lg max-w-[75%] break-words bg-blue-100 self-start text-left">محمد: خوبیییییییی</div><div id="-ORQ4R7WBFFmfZNCXDEy" class="p-3 rounded-lg max-w-[75%] break-words bg-green-100 self-end text-right">الهام: کیرررر</div></div>
      <div class="flex items-center p-4 border-t border-gray-200">
        <input id="msg" type="text" placeholder="پیام بنویسید..." class="flex-1 border border-gray-300 rounded-lg p-2 mr-2 focus:outline-none">
        <button id="send-btn" class="bg-green-500 text-white px-4 py-2 rounded-lg font-medium">
          ارسال
        </button>
      </div>
      <button id="clear-btn" class="m-4 bg-red-500 text-white py-2 rounded-lg font-medium hidden">
        پاک کردن تاریخچه
      </button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
    import {
      getDatabase, ref, push, onChildAdded, onChildRemoved,
      query, limitToLast, remove, set, get
    } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-database.js";

    // --- YOUR FIREBASE CONFIG HERE ---
    const firebaseConfig = {
      apiKey: "AIzaSyA5_iPT-1YjlJgKCsl6wNAIb-jsCTyoSKI",
      authDomain: "elhh-e2eee.firebaseapp.com",
      databaseURL: "https://elhh-e2eee-default-rtdb.firebaseio.com",
      projectId: "elhh-e2eee",
      storageBucket: "elhh-e2eee.firebasestorage.app",
      messagingSenderId: "1035622425636",
      appId: "1:1035622425636:web:09dd18e687490f9e22a4b1",
      measurementId: "G-2X7EH2QCJE"
    };
    // ----------------------------------

    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);
    let user = null;

    // --- اتصال سریع و وضعیت فیلترشکن ---
    const statusText = document.getElementById('status-text');
    const refreshBtn = document.getElementById('refresh-btn');

    let lastStatus = null; // true=connect, false=قطع, null=نامشخص
    let connectingToVPN = false;
    let failCount = 0;

    function updateStatus(state) {
      if (state === "connect") {
        statusText.textContent = "connect";
        statusText.className = "text-sm text-green-600 font-bold";
      } else if (state === "connecting") {
        statusText.textContent = "در حال اتصال به فیلترشکن...";
        statusText.className = "text-sm text-orange-500 font-bold";
      } else {
        statusText.textContent = "نیازمند به فیلترشکن";
        statusText.className = "text-sm text-red-500 font-bold";
      }
    }

    async function fastCheckConnection(timeoutMs = 1500) {
      let timer;
      let timedOut = false;

      const timeoutPromise = new Promise((_, reject) => {
        timer = setTimeout(() => {
          timedOut = true;
          reject(new Error("timeout"));
        }, timeoutMs);
      });

      try {
        await Promise.race([
          get(ref(db, 'test-connection')),
          timeoutPromise
        ]);
        clearTimeout(timer);
        return true;
      } catch (e) {
        if (!timedOut) clearTimeout(timer);
        return false;
      }
    }

    // سرعت چک: هر ۵۰۰ میلی&zwnj;ثانیه
    setInterval(async () => {
      const connected = await fastCheckConnection(1500);

      if (connected) {
        if (lastStatus !== true) {
          updateStatus("connect");
          lastStatus = true;
          failCount = 0;
          connectingToVPN = false;
        }
      } else {
        if (lastStatus === true || lastStatus === null) {
          connectingToVPN = true;
          failCount = 1;
          updateStatus("connecting");
          lastStatus = false;
        } else if (connectingToVPN && failCount < 1) {
          failCount++;
          updateStatus("connecting");
        } else {
          updateStatus("disconnected");
          connectingToVPN = false;
          lastStatus = false;
        }
      }
    }, 500);

    refreshBtn.onclick = () => location.reload();

    // --- بقیه کد احراز هویت و چت ---
    const monthSel      = document.getElementById('birth-month');
    const daySel        = document.getElementById('birth-day');
    const passwordDiv   = document.getElementById('password-container');
    const passInput     = document.getElementById('password');
    const loginBtn      = document.getElementById('login-btn');
    const authDiv       = document.getElementById('auth');
    const chatUi        = document.getElementById('chat-ui');
    const chatDiv       = document.getElementById('chat');
    const sendBtn       = document.getElementById('send-btn');
    const msgInput      = document.getElementById('msg');
    const clearBtn      = document.getElementById('clear-btn');
    const lastSeenDiv   = document.getElementById('last-seen');

    // Populate month select
    [{v:10,t:'دی'},{v:1,t:'فروردین'},{v:2,t:'اردیبهشت'}].forEach(m => {
      let o = document.createElement('option');
      o.value   = m.v;
      o.textContent = m.t;
      monthSel.append(o);
    });

    // Handlers for birth selects
    monthSel.addEventListener('change', () => {
      daySel.innerHTML = '<option value="">-- انتخاب روز --</option>';
      if (monthSel.value) {
        daySel.disabled = false;
        for (let i = 1; i <= 31; i++) {
          let o = document.createElement('option');
          o.value = i;
          o.textContent = i;
          daySel.append(o);
        }
      } else {
        daySel.disabled = true;
      }
      togglePasswordField();
      toggleLoginButton();
    });
    daySel.addEventListener('change', () => { togglePasswordField(); toggleLoginButton(); });
    passInput.addEventListener('input', toggleLoginButton);

    function togglePasswordField() {
      const isMohamad = (+monthSel.value === 10 && +daySel.value === 7);
      passwordDiv.classList.toggle('hidden', !isMohamad);
    }
    function toggleLoginButton() {
      const m = +monthSel.value, d = +daySel.value;
      const needPass = (m === 10 && d === 7);
      loginBtn.disabled = !(m && d && (!needPass || passInput.value));
    }

    loginBtn.addEventListener('click', async () => {
      const m = +monthSel.value, d = +daySel.value;
      if (m === 10 && d === 7) {
        if (passInput.value !== 'mohamad200') return alert('رمز اشتباه');
        user = 'محمد';
      }
      else if (m === 10 && d === 13) {
        user = 'الهام';
      }
      else {
        return alert('دسترسی فقط برای محمد و الهام');
      }

      // record last seen
      await set(ref(db, 'lastSeen/' + user), Date.now());

      // show chat UI
      authDiv.classList.add('hidden');
      chatUi.classList.remove('hidden');
      if (user === 'محمد') clearBtn.classList.remove('hidden');

      // if Mohammed, fetch and display Elham's last seen
      if (user === 'محمد') {
        const snap = await get(ref(db, 'lastSeen/الهام'));
        if (snap.exists()) {
          const last = new Date(+snap.val());
          const mins = Math.floor((Date.now() - last.getTime()) / 60000);
          lastSeenDiv.textContent =
            'آخرین بازدید الهام: ' + (mins < 1 ? 'همین الان' : mins + ' دقیقه پیش');
        }
      }

      // initial load from cache
      try {
        const cache = JSON.parse(localStorage.getItem('chat-cache') || '{}');
        Object.entries(cache).forEach(([key, msg]) => appendMessage(key, msg));
      } catch {}

      // realtime listeners (only last 50 + incremental)
      const msgsRef    = ref(db, 'messages');
      const recentQ    = query(msgsRef, limitToLast(50));
      onChildAdded(recentQ, snap => {
        const key = snap.key, msg = snap.val();
        appendMessage(key, msg);
        const c = JSON.parse(localStorage.getItem('chat-cache') || '{}');
        c[key] = msg;
        localStorage.setItem('chat-cache', JSON.stringify(c));
      });
      onChildRemoved(msgsRef, snap => {
        const key = snap.key;
        document.getElementById(key)?.remove();
        const c = JSON.parse(localStorage.getItem('chat-cache') || '{}');
        delete c[key];
        localStorage.setItem('chat-cache', JSON.stringify(c));
      });
    });

    function appendMessage(key, msg) {
      if (document.getElementById(key)) return;
      const d = document.createElement('div');
      d.id = key;
      d.className = [
        'p-3','rounded-lg','max-w-[75%]','break-words',
        msg.from === user
          ? 'bg-green-100 self-end text-right'
          : 'bg-blue-100 self-start text-left'
      ].join(' ');
      d.textContent = `${msg.from}: ${msg.text}`;
      if (user === 'محمد') {
        const btn = document.createElement('button');
        btn.textContent = '×';
        btn.className = 'absolute top-1 right-1 text-gray-500 hover:text-red-500';
        btn.onclick = () => remove(ref(db, 'messages/' + key));
        d.classList.add('relative');
        d.append(btn);
      }
      chatDiv.append(d);
      chatDiv.scrollTop = chatDiv.scrollHeight;
    }

    sendBtn.addEventListener('click', () => {
      if (!msgInput.value.trim()) return;
      push(ref(db, 'messages'), { from: user, text: msgInput.value });
      msgInput.value = '';
    });
    msgInput.addEventListener('keypress', e => {
      if (e.key === 'Enter') sendBtn.click();
    });

    clearBtn.addEventListener('click', () => {
      if (!confirm('پاک شدن کامل چت؟')) return;
      remove(ref(db, 'messages'));
      localStorage.removeItem('chat-cache');
      chatDiv.innerHTML = '';
    });
  </script>


</body></html>
